@page "/login"
@using Microsoft.AspNetCore.Components.Web
@using StudentTracker.Services
@using StudentTracker.Models
@inject NavigationManager Nav
@inject IAPIService API
@rendermode InteractiveServer


<div class="login-container">
    <h3>Login</h3>


    <div class="form-group">
        <label for="username">Username:</label>
        <input id="username" class="form-control" @bind="Username" @onkeydown="HandleKeyPress" />
    </div>

    <div class="form-group">
        <label for="password">Password:</label>
        <input id="password" class="form-control" type="password" @bind="Password" @onkeydown="HandleKeyPress" />
    </div>

    <button class="btn btn-primary btn-lg mt-3 w-100" @onclick="LoginClicked" disabled="@IsLoggedIn">Login</button>

@if (ShowError)
{
    <div class="text-danger mt-2">
        Login failed. Please check your username and password.
    </div>
}

@if (IsLoggedIn)
{
    <div class="text-success mt-2">
        Welcome, @Username! You are logged in.
    </div>
    <button class="btn btn-secondary mt-2" @onclick="LogoutClicked">Logout</button>
}

</div>

@code {
    private string Username { get; set; }
    private string Password { get; set; }
    private bool ShowError { get; set; } = false;
    private bool IsLoggedIn { get; set; } = false;

    private async Task LoginClicked()
    {
        try
        {
            List<User> potentialUsers = await API.GetUserAsync(Username, Password);
            if (potentialUsers.Count == 1)
            {
                API.CurrentUser = potentialUsers[0];
                ShowError = false;
                Nav.NavigateTo($"/messages/{potentialUsers[0].Id}");
            }
            else
            {
                ShowError = true;
                IsLoggedIn = false;
            }

            await Task.CompletedTask;
        }
        catch (HttpRequestException)
        {
            ShowError = true;
        }
    }

    private async Task LogoutClicked()
    {
        // Reset login state
        IsLoggedIn = false;
        Username = string.Empty;
        Password = string.Empty;
        ShowError = false;

        await Task.CompletedTask;
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await LoginClicked();
        }
    }
}