@page "/login"
@using Microsoft.AspNetCore.Components.Web
@using StudentTracker.Services
@using StudentTracker.Models
@inject NavigationManager Nav
@inject IAPIService API
@rendermode InteractiveServer

<h3>Login</h3>

<div>
    <label for="username">Username:</label>
    <input id="username" @bind="Username" @onkeydown="HandleKeyPress" />
</div>

<div>
    <label for="password">Password:</label>
    <input id="password" type="password" @bind="Password" @onkeydown="HandleKeyPress" />
</div>

<button @onclick="LoginClicked" disabled="@IsLoggedIn">Login</button>

@if (ShowError)
{
    <div class="text-danger mt-2">
        Login failed. Please check your username and password.
    </div>
}

@if (IsLoggedIn)
{
    <div class="text-success mt-2">
        Welcome, @Username! You are logged in.
    </div>
    <button class="btn btn-secondary mt-2" @onclick="LogoutClicked">Logout</button>
}

@code {
    private string Username { get; set; }
    private string Password { get; set; }
    private bool ShowError { get; set; } = false;
    private bool IsLoggedIn { get; set; } = false;

    private async Task LoginClicked()
    {
        try
        {
            List<User> potentialUsers = await API.GetUserAsync(Username, Password);
            if (potentialUsers.Count == 1)
            {
                API.CurrentUser = potentialUsers[0];
                ShowError = false;
                Nav.NavigateTo("/");
            }
            else
            {
                ShowError = true;
                IsLoggedIn = false;
            }

            await Task.CompletedTask;
        }
        catch (HttpRequestException)
        {
            ShowError = true;
        }
    }

    private async Task LogoutClicked()
    {
        // Reset login state
        IsLoggedIn = false;
        Username = string.Empty;
        Password = string.Empty;
        ShowError = false;

        await Task.CompletedTask;
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await LoginClicked();
        }
    }
}